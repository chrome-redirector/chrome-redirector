<html>
	<head>
		<script>

function init()
{
	hasUpdate = true;
}

/**
chrome.experimental.webNavigation.onBeforeNavigate.addListener(function(details) {
	if(hasUpdate) {
		updateData();
		hasUpdate = false;
	}

	for(var i = 1; i < ruleData.length; i++) {
		//ruleName = ruleData[i][0];
		matchPat = eval(ruleData[i][1]);
		blacklist = eval(ruleData[i][2]);
		subStr = eval(ruleData[i][3]);
		repl = ruleData[i][4];
		//testUrl = ruleData[i][5];

		if(matchPat.test(details.url) && !blacklist.test(details.url)) {
			chrome.tabs.update(details.tabId, {url: details.url.replace(subStr, repl)});
			return;
		}
	}

});
*/

function updateData()
{
	try {
		ruleData = JSON.parse(localStorage.ruleData);
	} catch(e) {
		ruleData = [];
		ruleData[0] = ["", "", "", "", "", ""];
	}
}

chrome.pageAction.onClicked.addListener(function(tab) {
	if(tab.url.match(/\.sixxs\.org/i)) {
		var newUrl = tab.url.replace(/\.sixxs\.org/i, ".to4.zju6.edu.cn");
	} else if(tab.url.match(/\.to4\.zju6\.edu\.cn/i)) {
		var newUrl = tab.url.replace(/\.to4\.zju6\.edu\.cn/i, "");
	} else {
		var newUrl = tab.url.replace(/(^(?:[a-z]+:\/\/)?[\w\.-]+)/, "$1.sixxs.org");
	}

	chrome.tabs.update(tab.id, {
		url: newUrl
	});
});

chrome.tabs.onCreated.addListener(function(tab) {
	chrome.pageAction.show(tab.id);
});

chrome.tabs.onUpdated.addListener(function(tabId, changeInfo, tab) {
	chrome.pageAction.show(tab.id);
});

chrome.extension.onConnect.addListener(function (port) {
	port.onMessage.addListener(function(msg) {
		if(port.name == "link") {
			linkUrl = msg.url;
			msg.url = null;

			chrome.tabs.getSelected(null, function(tab) {
				if(linkUrl) {
					chrome.tabs.create({
						index: tab.index + 1,
						url: linkUrl
					}, null);
				}
			});
		}/** else if(port.name == "update") {
			hasUpdate = msg.hasUpdate;
		}*/
	});
});

		</script>
	</head>
	<body onload="init()">
	</body>
</html>
